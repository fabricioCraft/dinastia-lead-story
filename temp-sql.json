{
  "sql": "CREATE OR REPLACE FUNCTION get_unified_origin_summary() RETURNS TABLE ( origin_name TEXT, lead_count BIGINT ) AS $$ BEGIN RETURN QUERY SELECT normalized_origin AS origin_name, COUNT(*) AS lead_count FROM ( SELECT CASE WHEN all_origins.raw_origin ILIKE '%ISCA SCOPELINE%' THEN 'Isca Scopeline' WHEN all_origins.raw_origin ILIKE '%ISCA HORMOZI%' THEN 'Isca Hormozi' WHEN all_origins.raw_origin ILIKE '%MASTERCLASS%' THEN 'Masterclass' WHEN all_origins.raw_origin ILIKE '%WEBINAR%' THEN 'Webinar' WHEN all_origins.raw_origin ILIKE '%FACEBOOK%' OR all_origins.raw_origin ILIKE '%FB%' THEN 'Facebook' WHEN all_origins.raw_origin ILIKE '%INSTAGRAM%' OR all_origins.raw_origin ILIKE '%IG%' THEN 'Instagram' WHEN all_origins.raw_origin ILIKE '%YOUTUBE%' OR all_origins.raw_origin ILIKE '%YT%' THEN 'YouTube' WHEN all_origins.raw_origin ILIKE '%GOOGLE%' THEN 'Google' WHEN all_origins.raw_origin ILIKE '%TIKTOK%' THEN 'TikTok' WHEN all_origins.raw_origin ILIKE '%LINKEDIN%' THEN 'LinkedIn' WHEN all_origins.raw_origin ILIKE '%EMAIL%' OR all_origins.raw_origin ILIKE '%NEWSLETTER%' THEN 'Email Marketing' WHEN all_origins.raw_origin ILIKE '%WHATSAPP%' OR all_origins.raw_origin ILIKE '%WPP%' THEN 'WhatsApp' WHEN all_origins.raw_origin ILIKE '%INDICACAO%' OR all_origins.raw_origin ILIKE '%REFERRAL%' THEN 'Indicação' WHEN all_origins.raw_origin ILIKE '%ORGANICO%' OR all_origins.raw_origin ILIKE '%ORGANIC%' THEN 'Orgânico' WHEN all_origins.raw_origin ILIKE '%PAID%' OR all_origins.raw_origin ILIKE '%PAGO%' THEN 'Tráfego Pago' ELSE 'Outros' END AS normalized_origin FROM ( SELECT origem AS raw_origin FROM public.leads2 WHERE origem IS NOT NULL AND origem <> '' UNION ALL SELECT utm_campaign AS raw_origin FROM public.\"MR_base_leads\" WHERE utm_campaign IS NOT NULL AND utm_campaign <> '' ) AS all_origins ) AS normalized_data GROUP BY normalized_origin ORDER BY lead_count DESC; END; $$ LANGUAGE plpgsql;"
}